<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lost Loot - AR View</title>
    <link rel="stylesheet" href="css/styles.css">
    <!-- A-Frame and AR.js -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.5/aframe/build/aframe-ar.min.js"></script>
</head>
<body class="ar-page">
    <!-- AR Scene -->
    <a-scene
        embedded
        arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;"
        renderer="logarithmicDepthBuffer: true;"
        vr-mode-ui="enabled: false"
        gesture-detector
        id="ar-scene"
        loading-screen="enabled: false"
    >
        <!-- Assets -->
        <a-assets>
            <!-- Placeholder for 3D models -->
            <a-asset-item id="compass-model" src="assets/models/compass.gltf"></a-asset-item>
            <a-asset-item id="ship-model" src="assets/models/ship.gltf"></a-asset-item>
            <a-asset-item id="chest-model" src="assets/models/chest.gltf"></a-asset-item>
            <a-asset-item id="skeleton-model" src="assets/models/skeleton.gltf"></a-asset-item>
            <a-asset-item id="key-model" src="assets/models/key.gltf"></a-asset-item>
            
            <!-- Marker patterns -->
            <!-- Note: a-marker-camera is not needed when using pattern markers -->
        </a-assets>
        
        <!-- Checkpoint 1: Captain's Compass -->
        <a-marker
            id="marker-1"
            type="pattern"
            url="assets/markers/marker-1.patt"
            markerhandler
            checkpoint="1"
            raycaster="objects: .interactive"
            cursor="fuse: false; rayOrigin: mouse"
        >
            <a-entity id="checkpoint-1-content" visible="false">
                <!-- Compass minigame -->
                <a-box
                    id="compass-box"
                    position="0 0.5 0"
                    rotation="0 45 0"
                    color="#8B4513"
                    scale="0.5 0.5 0.5"
                    class="interactive"
                    animation="property: rotation; to: 0 405 0; loop: true; dur: 4000"
                >
                    <a-text
                        value="Captain's Compass"
                        position="0 1 0"
                        align="center"
                        color="#FFD700"
                        scale="2 2 2"
                    ></a-text>
                </a-box>
                
                <!-- Compass needle -->
                <a-cylinder
                    id="compass-needle"
                    radius="0.02"
                    height="0.4"
                    color="#FF0000"
                    position="0 0.7 0"
                    rotation="0 0 0"
                ></a-cylinder>
                
                <!-- Instructions -->
                <a-text
                    value="Point your device north to activate the compass!"
                    position="0 -0.5 0"
                    align="center"
                    color="#FFFFFF"
                    scale="1.5 1.5 1.5"
                ></a-text>
            </a-entity>
        </a-marker>
        
        <!-- Fallback marker-1 using preset -->
        <a-marker
            id="marker-1-fallback"
            preset="hiro"
            markerhandler
            checkpoint="1"
            visible="false"
            raycaster="objects: .interactive"
            cursor="fuse: false; rayOrigin: mouse"
        >
            <a-entity id="checkpoint-1-fallback-content" visible="false">
                <!-- Same content as primary marker -->
                <a-box
                    position="0 0.5 0"
                    rotation="0 45 0"
                    color="#8B4513"
                    scale="0.5 0.5 0.5"
                    class="interactive"
                    animation="property: rotation; to: 0 405 0; loop: true; dur: 4000"
                >
                    <a-text
                        value="Captain's Compass (Hiro)"
                        position="0 1 0"
                        align="center"
                        color="#FFD700"
                        scale="2 2 2"
                    ></a-text>
                </a-box>
                
                <!-- Compass needle -->
                <a-cylinder
                    radius="0.02"
                    height="0.4"
                    color="#FF0000"
                    position="0 0.7 0"
                    rotation="0 0 0"
                ></a-cylinder>
                
                <!-- Instructions -->
                <a-text
                    value="Point your device north to activate the compass!"
                    position="0 -0.5 0"
                    align="center"
                    color="#FFFFFF"
                    scale="1.5 1.5 1.5"
                ></a-text>
            </a-entity>
        </a-marker>
        
        <!-- Checkpoint 2: Kraken's Quiz -->
        <a-marker
            id="marker-2"
            type="pattern"
            url="assets/markers/marker-2.patt"
            markerhandler
            checkpoint="2"
        >
            <a-entity id="checkpoint-2-content" visible="false">
                <!-- Kraken representation -->
                <a-sphere
                    id="kraken-head"
                    radius="0.3"
                    color="#4B0082"
                    position="0 0.5 0"
                    class="interactive"
                >
                    <a-text
                        value="Kraken's Quiz"
                        position="0 1 0"
                        align="center"
                        color="#FFD700"
                        scale="2 2 2"
                    ></a-text>
                </a-sphere>
                
                <!-- Tentacles -->
                <a-cylinder radius="0.05" height="0.8" color="#4B0082" position="0.2 0 0.2" rotation="15 0 0"></a-cylinder>
                <a-cylinder radius="0.05" height="0.8" color="#4B0082" position="-0.2 0 0.2" rotation="-15 0 0"></a-cylinder>
                <a-cylinder radius="0.05" height="0.8" color="#4B0082" position="0.2 0 -0.2" rotation="15 0 0"></a-cylinder>
                <a-cylinder radius="0.05" height="0.8" color="#4B0082" position="-0.2 0 -0.2" rotation="-15 0 0"></a-cylinder>
                
                <!-- Quiz question display -->
                <a-text
                    id="quiz-question"
                    value="What flag do pirates fly?\nA) Jolly Roger  B) Union Jack  C) Tricolor"
                    position="0 -0.5 0"
                    align="center"
                    color="#FFFFFF"
                    scale="1.2 1.2 1.2"
                ></a-text>
            </a-entity>
        </a-marker>
        
        <!-- Checkpoint 3: Cannonball Accuracy -->
        <a-marker
            id="marker-3"
            type="pattern" 
            url="assets/markers/marker-3.patt"
            markerhandler
            checkpoint="3"
        >
            <a-entity id="checkpoint-3-content" visible="false">
                <!-- Cannon -->
                <a-cylinder
                    id="cannon"
                    radius="0.1"
                    height="0.6"
                    color="#2F4F4F"
                    rotation="0 0 90"
                    position="0 0.3 0"
                    class="interactive"
                ></a-cylinder>
                
                <!-- Target -->
                <a-ring
                    id="target"
                    radius-inner="0.1"
                    radius-outer="0.2"
                    color="#FF0000"
                    position="0 0.5 -1"
                    class="interactive"
                ></a-ring>
                
                <a-text
                    value="Cannonball Accuracy\nTap to fire!"
                    position="0 1 0"
                    align="center"
                    color="#FFD700"
                    scale="1.5 1.5 1.5"
                ></a-text>
            </a-entity>
        </a-marker>
        
        
        <!-- Additional markers for checkpoints 4-8 -->
        <!-- Checkpoint 4: Treasure Chest Lock -->
        <a-marker id="marker-4" type="pattern" url="assets/markers/marker-4.patt" markerhandler checkpoint="4">
            <a-entity id="checkpoint-4-content" visible="false">
                <!-- Enhanced treasure chest with lock mechanism -->
                <a-box 
                    position="0 0.5 0" 
                    color="#8B4513" 
                    scale="0.8 0.5 0.6"
                    class="interactive"
                    animation__hover="property: scale; to: 0.85 0.52 0.62; startEvents: mouseenter; endEvents: mouseleave; dur: 200"
                >
                    <!-- Lock mechanism on front -->
                    <a-cylinder 
                        radius="0.15" 
                        height="0.05" 
                        color="#C0C0C0" 
                        position="0 0 0.31"
                        class="interactive"
                    ></a-cylinder>
                    <a-torus 
                        radius="0.1" 
                        radius-tubular="0.02" 
                        color="#FFD700" 
                        position="0 0.1 0.31"
                        rotation="0 0 0"
                        animation="property: rotation; to: 0 0 360; dur: 3000; loop: true"
                    ></a-torus>
                    
                    <!-- Chest decorations -->
                    <a-box 
                        position="0.25 0 0.25" 
                        scale="0.1 0.4 0.1" 
                        color="#CD7F32"
                    ></a-box>
                    <a-box 
                        position="-0.25 0 0.25" 
                        scale="0.1 0.4 0.1" 
                        color="#CD7F32"
                    ></a-box>
                </a-box>
                
                <!-- Floating keys around the chest -->
                <a-entity 
                    animation="property: rotation; to: 0 360 0; dur: 5000; loop: true"
                >
                    <a-box 
                        position="0.6 0.8 0" 
                        scale="0.15 0.05 0.4" 
                        color="#FFD700"
                        class="interactive"
                    ></a-box>
                    <a-cylinder 
                        position="0.6 0.8 -0.2" 
                        radius="0.08" 
                        height="0.05" 
                        color="#FFD700"
                    ></a-cylinder>
                </a-entity>
                
                <a-text 
                    value="Treasure Chest Lock\nFind the right combination!" 
                    position="0 1.2 0" 
                    align="center" 
                    color="#FFD700" 
                    scale="1.2 1.2 1.2"
                ></a-text>
            </a-entity>
        </a-marker>
        
        <!-- Checkpoint 5: Pirate's Balance -->
        <a-marker id="marker-5" type="pattern" url="assets/markers/marker-5.patt" markerhandler checkpoint="5">
            <a-entity id="checkpoint-5-content" visible="false">
                <!-- Enhanced balance scale -->
                <a-cylinder 
                    radius="0.02" 
                    height="1.0" 
                    color="#8B4513" 
                    position="0 0.5 0"
                ></a-cylinder>
                
                <!-- Balance beam -->
                <a-box 
                    position="0 1.0 0" 
                    scale="1.2 0.05 0.1" 
                    color="#CD7F32"
                    class="interactive"
                    animation="property: rotation; to: 0 0 5; dur: 2000; direction: alternate; loop: true"
                ></a-box>
                
                <!-- Left scale plate -->
                <a-entity position="-0.5 0.9 0">
                    <a-cylinder 
                        radius="0.2" 
                        height="0.02" 
                        color="#C0C0C0"
                        class="interactive"
                    ></a-cylinder>
                    <!-- Chains -->
                    <a-cylinder 
                        radius="0.01" 
                        height="0.15" 
                        color="#696969" 
                        position="0.15 0.075 0"
                    ></a-cylinder>
                    <a-cylinder 
                        radius="0.01" 
                        height="0.15" 
                        color="#696969" 
                        position="-0.15 0.075 0"
                    ></a-cylinder>
                    <!-- Treasure on left plate -->
                    <a-sphere 
                        radius="0.08" 
                        color="#FFD700" 
                        position="0 0.1 0"
                        animation="property: position; to: 0 0.15 0; dur: 1500; direction: alternate; loop: true"
                    ></a-sphere>
                </a-entity>
                
                <!-- Right scale plate -->
                <a-entity position="0.5 0.9 0">
                    <a-cylinder 
                        radius="0.2" 
                        height="0.02" 
                        color="#C0C0C0"
                        class="interactive"
                    ></a-cylinder>
                    <!-- Chains -->
                    <a-cylinder 
                        radius="0.01" 
                        height="0.15" 
                        color="#696969" 
                        position="0.15 0.075 0"
                    ></a-cylinder>
                    <a-cylinder 
                        radius="0.01" 
                        height="0.15" 
                        color="#696969" 
                        position="-0.15 0.075 0"
                    ></a-cylinder>
                    <!-- Weight stones on right plate -->
                    <a-box 
                        scale="0.1 0.1 0.1" 
                        color="#696969" 
                        position="0 0.08 0"
                    ></a-box>
                    <a-box 
                        scale="0.08 0.08 0.08" 
                        color="#2F4F4F" 
                        position="0.05 0.15 0.05"
                    ></a-box>
                </a-entity>
                
                <a-text 
                    value="Pirate's Balance\nBalance the treasure!" 
                    position="0 1.4 0" 
                    align="center" 
                    color="#FFD700" 
                    scale="1.2 1.2 1.2"
                ></a-text>
            </a-entity>
        </a-marker>
        
        <!-- Checkpoint 6: Skeleton Duel -->
        <a-marker id="marker-6" type="pattern" url="assets/markers/marker-6.patt" markerhandler checkpoint="6">
            <a-entity id="checkpoint-6-content" visible="false">
                <!-- Enhanced skeleton figure -->
                <!-- Head -->
                <a-sphere 
                    radius="0.15" 
                    color="#F5F5DC" 
                    position="0 0.85 0"
                    class="interactive"
                    animation="property: rotation; to: 10 0 0; dur: 2000; direction: alternate; loop: true"
                >
                    <!-- Eye sockets -->
                    <a-sphere radius="0.03" color="#000000" position="0.05 0.02 0.12"></a-sphere>
                    <a-sphere radius="0.03" color="#000000" position="-0.05 0.02 0.12"></a-sphere>
                    <!-- Glowing eyes -->
                    <a-sphere 
                        radius="0.02" 
                        color="#FF0000" 
                        position="0.05 0.02 0.13"
                        animation="property: scale; to: 1.5 1.5 1.5; dur: 1000; direction: alternate; loop: true"
                    ></a-sphere>
                    <a-sphere 
                        radius="0.02" 
                        color="#FF0000" 
                        position="-0.05 0.02 0.13"
                        animation="property: scale; to: 1.5 1.5 1.5; dur: 1000; direction: alternate; loop: true"
                    ></a-sphere>
                </a-sphere>
                
                <!-- Neck/Spine -->
                <a-cylinder 
                    radius="0.03" 
                    height="0.3" 
                    color="#F5F5DC" 
                    position="0 0.55 0"
                ></a-cylinder>
                
                <!-- Torso (ribcage) -->
                <a-entity position="0 0.4 0">
                    <a-cylinder radius="0.1" height="0.4" color="#F5F5DC" class="interactive"></a-cylinder>
                    <!-- Ribs -->
                    <a-torus radius="0.08" radius-tubular="0.01" color="#E0E0E0" position="0 0.1 0"></a-torus>
                    <a-torus radius="0.09" radius-tubular="0.01" color="#E0E0E0" position="0 0.05 0"></a-torus>
                    <a-torus radius="0.08" radius-tubular="0.01" color="#E0E0E0" position="0 0 0"></a-torus>
                    <a-torus radius="0.07" radius-tubular="0.01" color="#E0E0E0" position="0 -0.05 0"></a-torus>
                </a-entity>
                
                <!-- Arms -->
                <a-entity>
                    <!-- Left arm -->
                    <a-cylinder 
                        radius="0.02" 
                        height="0.35" 
                        color="#F5F5DC" 
                        position="-0.15 0.5 0" 
                        rotation="0 0 -30"
                        animation="property: rotation; to: 0 0 -45; dur: 1500; direction: alternate; loop: true"
                    ></a-cylinder>
                    <!-- Right arm with sword -->
                    <a-cylinder 
                        radius="0.02" 
                        height="0.35" 
                        color="#F5F5DC" 
                        position="0.15 0.5 0" 
                        rotation="0 0 30"
                        animation="property: rotation; to: 0 0 45; dur: 1500; direction: alternate; loop: true"
                    ></a-cylinder>
                    <!-- Sword -->
                    <a-entity 
                        position="0.25 0.7 0"
                        animation="property: rotation; to: 0 0 60; dur: 1500; direction: alternate; loop: true"
                    >
                        <a-cylinder radius="0.01" height="0.3" color="#C0C0C0" rotation="0 0 90"></a-cylinder>
                        <a-box scale="0.15 0.03 0.01" color="#8B4513" position="0.15 0 0"></a-box>
                    </a-entity>
                </a-entity>
                
                <!-- Legs -->
                <a-cylinder 
                    radius="0.02" 
                    height="0.4" 
                    color="#F5F5DC" 
                    position="-0.05 0.05 0"
                ></a-cylinder>
                <a-cylinder 
                    radius="0.02" 
                    height="0.4" 
                    color="#F5F5DC" 
                    position="0.05 0.05 0"
                ></a-cylinder>
                
                <!-- Ghostly aura -->
                <a-sphere 
                    radius="0.6" 
                    color="#00FF00" 
                    opacity="0.1" 
                    position="0 0.5 0"
                    animation="property: scale; to: 1.2 1.2 1.2; dur: 2000; direction: alternate; loop: true"
                ></a-sphere>
                
                <a-text 
                    value="Skeleton Duel\nDefeat the undead pirate!" 
                    position="0 1.3 0" 
                    align="center" 
                    color="#FFD700" 
                    scale="1.2 1.2 1.2"
                ></a-text>
            </a-entity>
        </a-marker>
        
        <!-- Checkpoint 7: Map Assembly -->
        <a-marker id="marker-7" type="pattern" url="assets/markers/marker-7.patt" markerhandler checkpoint="7">
            <a-entity id="checkpoint-7-content" visible="false">
                <!-- Enhanced treasure map with multiple pieces -->
                <a-entity position="0 0.5 0" rotation="-15 0 0">
                    <!-- Main map base -->
                    <a-plane 
                        width="1.0" 
                        height="0.8" 
                        color="#DEB887" 
                        position="0 0 0"
                        class="interactive"
                        animation="property: rotation; to: -10 0 0; dur: 3000; direction: alternate; loop: true"
                    >
                        <!-- Map grid lines -->
                        <a-entity>
                            <a-box scale="1.0 0.01 0.01" color="#8B4513" position="0 0.2 0.01"></a-box>
                            <a-box scale="1.0 0.01 0.01" color="#8B4513" position="0 0 0.01"></a-box>
                            <a-box scale="1.0 0.01 0.01" color="#8B4513" position="0 -0.2 0.01"></a-box>
                            <a-box scale="0.01 0.8 0.01" color="#8B4513" position="0.3 0 0.01"></a-box>
                            <a-box scale="0.01 0.8 0.01" color="#8B4513" position="0 0 0.01"></a-box>
                            <a-box scale="0.01 0.8 0.01" color="#8B4513" position="-0.3 0 0.01"></a-box>
                        </a-entity>
                        
                        <!-- Islands and landmarks -->
                        <a-circle radius="0.08" color="#228B22" position="0.2 0.1 0.02"></a-circle>
                        <a-circle radius="0.05" color="#228B22" position="-0.3 0.2 0.02"></a-circle>
                        <a-circle radius="0.06" color="#228B22" position="0.1 -0.2 0.02"></a-circle>
                        
                        <!-- X marks the spot -->
                        <a-entity position="0.2 0.1 0.03">
                            <a-box scale="0.15 0.02 0.01" color="#FF0000" rotation="0 0 45"></a-box>
                            <a-box scale="0.15 0.02 0.01" color="#FF0000" rotation="0 0 -45"></a-box>
                        </a-entity>
                    </a-plane>
                    
                    <!-- Floating map pieces that need to be assembled -->
                    <a-entity 
                        animation="property: rotation; to: 0 360 0; dur: 8000; loop: true"
                    >
                        <!-- Top piece -->
                        <a-plane 
                            width="0.3" 
                            height="0.2" 
                            color="#D2B48C" 
                            position="0.8 0.6 0.1"
                            class="interactive"
                            animation__float="property: position; to: 0.8 0.8 0.1; dur: 2000; direction: alternate; loop: true"
                        ></a-plane>
                        
                        <!-- Left piece -->
                        <a-plane 
                            width="0.25" 
                            height="0.3" 
                            color="#D2B48C" 
                            position="-0.8 0.2 0.1"
                            class="interactive"
                            animation__float="property: position; to: -0.8 0.4 0.1; dur: 2500; direction: alternate; loop: true"
                        ></a-plane>
                        
                        <!-- Right piece -->
                        <a-plane 
                            width="0.2" 
                            height="0.25" 
                            color="#D2B48C" 
                            position="0.7 -0.4 0.1"
                            class="interactive"
                            animation__float="property: position; to: 0.7 -0.2 0.1; dur: 3000; direction: alternate; loop: true"
                        ></a-plane>
                    </a-entity>
                    
                    <!-- Compass rose -->
                    <a-entity position="0.35 0.25 0.05">
                        <a-ring 
                            radius-inner="0.05" 
                            radius-outer="0.08" 
                            color="#8B4513"
                            animation="property: rotation; to: 0 0 360; dur: 10000; loop: true"
                        ></a-ring>
                        <a-cone 
                            radius-bottom="0.02" 
                            height="0.06" 
                            color="#FF0000" 
                            position="0 0 0.01"
                        ></a-cone>
                    </a-entity>
                </a-entity>
                
                <a-text 
                    value="Map Assembly\nCollect the missing pieces!" 
                    position="0 1.2 0" 
                    align="center" 
                    color="#FFD700" 
                    scale="1.2 1.2 1.2"
                ></a-text>
            </a-entity>
        </a-marker>
        
        <!-- Checkpoint 8: The Lost Loot -->
        <a-marker id="marker-8" type="pattern" url="assets/markers/marker-8.patt" markerhandler checkpoint="8">
            <a-entity id="checkpoint-8-content" visible="false">
                <!-- Enhanced treasure hoard -->
                <!-- Main treasure chest -->
                <a-entity position="0 0.4 0">
                    <a-box 
                        position="0 0 0" 
                        color="#8B4513" 
                        scale="0.8 0.4 0.6"
                        class="interactive"
                        animation="property: rotation; to: 0 5 0; dur: 2000; direction: alternate; loop: true"
                    >
                        <!-- Chest lid (open) -->
                        <a-box 
                            color="#654321" 
                            scale="1.02 0.25 1.02" 
                            position="0 0.4 -0.3" 
                            rotation="45 0 0"
                            animation="property: rotation; to: 60 0 0; dur: 3000; direction: alternate; loop: true"
                        ></a-box>
                        
                        <!-- Gold decorations -->
                        <a-cylinder radius="0.05" height="0.02" color="#FFD700" position="0.3 0 0.31"></a-cylinder>
                        <a-cylinder radius="0.05" height="0.02" color="#FFD700" position="-0.3 0 0.31"></a-cylinder>
                    </a-box>
                    
                    <!-- Overflowing treasure -->
                    <a-entity position="0 0.3 0">
                        <!-- Gold coins -->
                        <a-cylinder 
                            radius="0.05" 
                            height="0.01" 
                            color="#FFD700" 
                            position="0.1 0.2 0.1"
                            animation="property: position; to: 0.1 0.35 0.1; dur: 2000; direction: alternate; loop: true"
                        ></a-cylinder>
                        <a-cylinder 
                            radius="0.05" 
                            height="0.01" 
                            color="#FFD700" 
                            position="-0.1 0.25 0.15"
                            animation="property: position; to: -0.1 0.4 0.15; dur: 2500; direction: alternate; loop: true"
                        ></a-cylinder>
                        <a-cylinder 
                            radius="0.05" 
                            height="0.01" 
                            color="#FFD700" 
                            position="0.05 0.3 -0.1"
                            animation="property: position; to: 0.05 0.45 -0.1; dur: 1800; direction: alternate; loop: true"
                        ></a-cylinder>
                        
                        <!-- Precious gems -->
                        <a-octahedron 
                            radius="0.04" 
                            color="#FF69B4" 
                            position="0.2 0.25 0"
                            animation="property: rotation; to: 360 360 360; dur: 4000; loop: true"
                        ></a-octahedron>
                        <a-octahedron 
                            radius="0.03" 
                            color="#00CED1" 
                            position="-0.15 0.3 0.1"
                            animation="property: rotation; to: 360 360 360; dur: 3500; loop: true"
                        ></a-octahedron>
                        <a-octahedron 
                            radius="0.035" 
                            color="#32CD32" 
                            position="0 0.35 0.2"
                            animation="property: rotation; to: 360 360 360; dur: 4500; loop: true"
                        ></a-octahedron>
                    </a-entity>
                </a-entity>
                
                <!-- Scattered treasure around the chest -->
                <a-entity 
                    animation="property: rotation; to: 0 360 0; dur: 12000; loop: true"
                >
                    <!-- Gold piles -->
                    <a-sphere 
                        radius="0.1" 
                        color="#FFD700" 
                        position="0.6 0.1 0.3"
                        animation__bounce="property: scale; to: 1.1 1.1 1.1; dur: 1500; direction: alternate; loop: true"
                    ></a-sphere>
                    <a-sphere 
                        radius="0.08" 
                        color="#FFD700" 
                        position="-0.5 0.08 0.4"
                        animation__bounce="property: scale; to: 1.15 1.15 1.15; dur: 2000; direction: alternate; loop: true"
                    ></a-sphere>
                    <a-sphere 
                        radius="0.12" 
                        color="#FFD700" 
                        position="0.4 0.12 -0.5"
                        animation__bounce="property: scale; to: 1.2 1.2 1.2; dur: 1800; direction: alternate; loop: true"
                    ></a-sphere>
                    
                    <!-- Treasure cups and goblets -->
                    <a-cylinder 
                        radius="0.06" 
                        height="0.15" 
                        color="#C0C0C0" 
                        position="-0.7 0.075 0"
                        animation="property: rotation; to: 0 0 10; dur: 2500; direction: alternate; loop: true"
                    ></a-cylinder>
                    <a-cylinder 
                        radius="0.05" 
                        height="0.12" 
                        color="#FFD700" 
                        position="0.7 0.06 -0.2"
                        animation="property: rotation; to: 0 0 -8; dur: 2200; direction: alternate; loop: true"
                    ></a-cylinder>
                </a-entity>
                
                <!-- Glittering particle effect simulation -->
                <a-entity position="0 0.8 0">
                    <a-sphere 
                        radius="0.01" 
                        color="#FFD700" 
                        opacity="0.7"
                        position="0.3 0 0.2"
                        animation="property: position; to: 0.3 0.5 0.2; dur: 3000; direction: alternate; loop: true"
                    ></a-sphere>
                    <a-sphere 
                        radius="0.01" 
                        color="#FFD700" 
                        opacity="0.7"
                        position="-0.2 0 0.3"
                        animation="property: position; to: -0.2 0.4 0.3; dur: 2500; direction: alternate; loop: true"
                    ></a-sphere>
                    <a-sphere 
                        radius="0.01" 
                        color="#FFD700" 
                        opacity="0.7"
                        position="0.1 0 -0.2"
                        animation="property: position; to: 0.1 0.6 -0.2; dur: 3500; direction: alternate; loop: true"
                    ></a-sphere>
                </a-entity>
                
                <a-text 
                    value="The Lost Loot!\nYou found the treasure!" 
                    position="0 1.3 0" 
                    align="center" 
                    color="#FFD700" 
                    scale="1.3 1.3 1.3"
                    animation="property: scale; to: 1.4 1.4 1.4; dur: 2000; direction: alternate; loop: true"
                ></a-text>
            </a-entity>
        </a-marker>
        
        <!-- Fallback preset markers for better detection reliability -->
        <a-marker id="marker-2-fallback" preset="kanji" markerhandler checkpoint="2" visible="false">
            <a-entity id="checkpoint-2-fallback-content" visible="false">
                <a-sphere radius="0.3" color="#4B0082" position="0 0.5 0" class="interactive">
                    <a-text value="Kraken's Quiz (Kanji)" position="0 1 0" align="center" color="#FFD700" scale="2 2 2"></a-text>
                </a-sphere>
            </a-entity>
        </a-marker>
        
        <!-- Additional fallback markers using different presets -->
        <a-marker id="marker-3-fallback" preset="hiro" markerhandler checkpoint="3" visible="false">
            <a-entity id="checkpoint-3-fallback-content" visible="false">
                <a-cylinder radius="0.1" height="0.6" color="#2F4F4F" rotation="0 0 90" position="0 0.3 0" class="interactive"></a-cylinder>
                <a-text value="Cannonball Accuracy (Hiro)" position="0 1 0" align="center" color="#FFD700" scale="1.5 1.5 1.5"></a-text>
            </a-entity>
        </a-marker>
        
        <!-- Additional fallback markers for checkpoints 4-8 for better detection reliability -->
        <a-marker id="marker-4-fallback" preset="kanji" markerhandler checkpoint="4" visible="false">
            <a-entity id="checkpoint-4-fallback-content" visible="false">
                <a-box position="0 0.5 0" color="#8B4513" scale="0.6 0.4 0.4" class="interactive">
                    <a-text value="Treasure Chest Lock (Kanji)" position="0 1 0" align="center" color="#FFD700" scale="1.2 1.2 1.2"></a-text>
                    <a-cylinder radius="0.1" height="0.05" color="#C0C0C0" position="0 0 0.21"></a-cylinder>
                </a-box>
            </a-entity>
        </a-marker>
        
        <a-marker id="marker-5-fallback" preset="hiro" markerhandler checkpoint="5" visible="false">
            <a-entity id="checkpoint-5-fallback-content" visible="false">
                <a-cylinder radius="0.02" height="0.8" color="#8B4513" position="0 0.4 0" class="interactive"></a-cylinder>
                <a-box position="0 0.8 0" scale="1.0 0.05 0.1" color="#CD7F32" class="interactive"></a-box>
                <a-text value="Pirate's Balance (Hiro)" position="0 1.2 0" align="center" color="#FFD700" scale="1.2 1.2 1.2"></a-text>
            </a-entity>
        </a-marker>
        
        <a-marker id="marker-6-fallback" preset="kanji" markerhandler checkpoint="6" visible="false">
            <a-entity id="checkpoint-6-fallback-content" visible="false">
                <a-sphere radius="0.15" color="#F5F5DC" position="0 0.7 0" class="interactive">
                    <a-sphere radius="0.02" color="#FF0000" position="0.05 0.02 0.13"></a-sphere>
                    <a-sphere radius="0.02" color="#FF0000" position="-0.05 0.02 0.13"></a-sphere>
                </a-sphere>
                <a-cylinder radius="0.08" height="0.4" color="#F5F5DC" position="0 0.35 0" class="interactive"></a-cylinder>
                <a-text value="Skeleton Duel (Kanji)" position="0 1.2 0" align="center" color="#FFD700" scale="1.2 1.2 1.2"></a-text>
            </a-entity>
        </a-marker>
        
        <a-marker id="marker-7-fallback" preset="hiro" markerhandler checkpoint="7" visible="false">
            <a-entity id="checkpoint-7-fallback-content" visible="false">
                <a-plane width="0.8" height="0.6" color="#DEB887" position="0 0.5 0" rotation="-10 0 0" class="interactive">
                    <a-box scale="0.1 0.01 0.01" color="#8B4513" position="0.2 0.1 0.01"></a-box>
                    <a-box scale="0.1 0.01 0.01" color="#FF0000" position="0.2 0.1 0.02" rotation="0 0 45"></a-box>
                    <a-box scale="0.1 0.01 0.01" color="#FF0000" position="0.2 0.1 0.02" rotation="0 0 -45"></a-box>
                </a-plane>
                <a-text value="Map Assembly (Hiro)" position="0 1.1 0" align="center" color="#FFD700" scale="1.2 1.2 1.2"></a-text>
            </a-entity>
        </a-marker>
        
        <a-marker id="marker-8-fallback" preset="kanji" markerhandler checkpoint="8" visible="false">
            <a-entity id="checkpoint-8-fallback-content" visible="false">
                <a-box position="0 0.5 0" color="#FFD700" scale="0.6 0.3 0.5" class="interactive">
                    <a-sphere radius="0.08" color="#FFD700" position="0.2 0.5 0.2"></a-sphere>
                    <a-sphere radius="0.08" color="#FFD700" position="-0.2 0.5 0.2"></a-sphere>
                    <a-sphere radius="0.08" color="#FFD700" position="0 0.5 -0.2"></a-sphere>
                </a-box>
                <a-text value="The Lost Loot! (Kanji)" position="0 1.2 0" align="center" color="#FFD700" scale="1.2 1.2 1.2"></a-text>
            </a-entity>
        </a-marker>
        
        <!-- For brevity, I'll implement the remaining markers in the JavaScript -->
        
        <!-- Camera -->
        <a-entity camera look-controls wasd-controls-enabled="false"></a-entity>
    </a-scene>
    
    <!-- AR UI Overlay -->
    <div class="ar-ui-overlay">
        <header class="ar-header">
            <button id="back-to-hud" class="back-btn">← Back to HUD</button>
            <h2 id="ar-title">Scan a Marker</h2>
        </header>
        
        <div id="ar-instructions" class="ar-instructions">
            <p>Point your camera at an AR marker to begin the minigame</p>
        </div>
        
        <!-- Minigame UI -->
        <div id="minigame-ui" class="minigame-ui" style="display: none;">
            <div id="minigame-content"></div>
            <div class="minigame-controls">
                <button id="minigame-action" class="action-btn">Action</button>
                <button id="minigame-reset" class="reset-btn">Reset</button>
            </div>
        </div>
        
        <!-- Progress indicator -->
        <div id="checkpoint-indicator" class="checkpoint-indicator">
            <span id="current-checkpoint">Checkpoint: None</span>
            <div id="progress-bar" class="progress-bar">
                <div id="progress-fill" class="progress-fill"></div>
            </div>
        </div>
    </div>
    
    <!-- Scripts -->
    <script src="js/utils.js"></script>
    <script src="js/api-client.js"></script>
    <script src="js/game-state.js"></script>
    <script src="js/ar-minigames.js"></script>
    
    <script>
        let currentCheckpoint = null;
        let currentMinigame = null;
        let deviceOrientationHandler = null;
        let arSceneReady = false;
        let arInitialized = false;
        
        // Initialize AR view with proper error handling
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('DOM loaded, initializing AR view...');
            
            try {
                // Check if team is logged in with enhanced error handling
                let gameInitialized = false;
                try {
                    if (GameState && typeof GameState.isInitialized === 'function') {
                        gameInitialized = GameState.isInitialized();
                        console.log('GameState initialization check:', gameInitialized);
                    } else {
                        console.warn('GameState not available or isInitialized method missing');
                    }
                } catch (error) {
                    console.error('Error checking GameState initialization:', error);
                    showMessage('Game state unavailable - continuing with offline AR functionality');
                }
                
                // Only redirect if GameState is available and not initialized
                if (GameState && typeof GameState.isInitialized === 'function' && !gameInitialized) {
                    console.log('Game not initialized, redirecting to index.html');
                    window.location.href = 'index.html';
                    return;
                }
                
                // Check AR.js compatibility first - with retry logic
                let compatibilityCheck;
                let retryCount = 0;
                const maxRetries = 3;
                
                do {
                    compatibilityCheck = await ARUtils.checkARjsCompatibility();
                    if (!compatibilityCheck.compatible && retryCount < maxRetries) {
                        console.log(`AR.js compatibility check failed (attempt ${retryCount + 1}/${maxRetries + 1}), retrying...`);
                        await new Promise(resolve => setTimeout(resolve, 1000)); // Wait 1 second
                        retryCount++;
                    }
                } while (!compatibilityCheck.compatible && retryCount <= maxRetries);
                
                if (!compatibilityCheck.compatible) {
                    console.error('AR.js compatibility issue:', compatibilityCheck.reason);
                    showError(`AR compatibility issue: ${compatibilityCheck.reason}. Please refresh the page and ensure A-Frame and AR.js are loaded.`);
                    return;
                }
                
                // Check AR support before proceeding
                if (!await checkARSupport()) {
                    showError('AR is not supported on this device. Please use a device with camera support.');
                    return;
                }
                
                // Validate marker files
                await validateMarkerFiles();
                
                // Request camera permission early
                const cameraPermission = await requestCameraPermission();
                if (!cameraPermission) {
                    showError('Camera permission is required for AR functionality. Please allow camera access and refresh the page.');
                    return;
                }
                
                setupEventListeners();
                
                // Wait for A-Frame scene to be ready before registering components
                const scene = document.querySelector('#ar-scene');
                if (scene.hasLoaded) {
                    console.log('A-Frame scene already loaded');
                    onSceneReady();
                } else {
                    console.log('Waiting for A-Frame scene to load...');
                    scene.addEventListener('loaded', onSceneReady);
                    
                    // Add timeout for scene loading
                    setTimeout(() => {
                        if (!arSceneReady) {
                            console.error('Scene loading timeout');
                            showError('AR scene failed to load. Please refresh the page.');
                        }
                    }, 10000); // 10 second timeout
                }
                
                requestDeviceOrientation();
                
            } catch (error) {
                console.error('Error initializing AR view:', error);
                showError('Failed to initialize AR view. Please refresh the page and try again.');
            }
        });
        
        async function validateMarkerFiles() {
            console.log('Validating marker files...');
            const markerUrls = [
                'assets/markers/marker-1.patt',
                'assets/markers/marker-2.patt',
                'assets/markers/marker-3.patt',
                'assets/markers/marker-4.patt',
                'assets/markers/marker-5.patt',
                'assets/markers/marker-6.patt',
                'assets/markers/marker-7.patt',
                'assets/markers/marker-8.patt'
            ];
            
            const validationResults = await Promise.all(
                markerUrls.map(url => ARUtils.validateMarkerFile(url))
            );
            
            const failedMarkers = markerUrls.filter((url, index) => !validationResults[index]);
            
            if (failedMarkers.length > 0) {
                console.warn('Some marker files failed validation:', failedMarkers);
                showMessage(`Some marker patterns may not work properly. Fallback markers available.`);
            } else {
                console.log('All marker files validated successfully');
            }
        }
        
        async function checkARSupport() {
            try {
                // Use existing ARUtils function
                const supported = ARUtils.isARSupported();
                console.log('AR support check result:', supported);
                return supported;
            } catch (error) {
                console.error('AR support check failed:', error);
                return false;
            }
        }
        
        async function requestCameraPermission() {
            try {
                console.log('Requesting camera permission...');
                // Use existing ARUtils function
                const granted = await ARUtils.requestCameraPermission();
                console.log('Camera permission result:', granted);
                return granted;
            } catch (error) {
                console.error('Camera permission error:', error);
                return false;
            }
        }
        
        function onSceneReady() {
            console.log('A-Frame scene is ready, initializing AR components...');
            arSceneReady = true;
            
            try {
                initializeMarkerHandlers();
                initializeARErrorHandling();
                arInitialized = true;
                console.log('AR initialization completed successfully');
                showMessage('AR initialized. Point your camera at a marker to begin!');
            } catch (error) {
                console.error('Error during AR initialization:', error);
                showError('Failed to initialize AR components. Please refresh the page.');
            }
        }
        
        function initializeARErrorHandling() {
            const scene = document.querySelector('#ar-scene');
            
            // Handle AR.js errors with specific error types
            scene.addEventListener('arError', (event) => {
                console.error('AR Error:', event.detail);
                const errorType = event.detail?.type || 'unknown';
                let errorMessage = 'AR tracking error. Please ensure good lighting and try again.';
                
                switch (errorType) {
                    case 'camera':
                        errorMessage = 'Camera error. Please check camera permissions and refresh the page.';
                        break;
                    case 'marker':
                        errorMessage = 'Marker detection error. Please ensure the marker is visible and well-lit.';
                        break;
                    case 'webgl':
                        errorMessage = 'WebGL error. Please try refreshing the page or use a different browser.';
                        break;
                    default:
                        errorMessage = `AR error (${errorType}). Please ensure good lighting and try again.`;
                }
                
                showError(errorMessage);
            });
            
            // Handle camera errors specifically
            scene.addEventListener('camera-error', (event) => {
                console.error('Camera Error:', event.detail);
                const errorDetail = event.detail?.message || 'Unknown camera error';
                showError(`Camera error: ${errorDetail}. Please check camera permissions and try again.`);
            });
            
            // Handle WebGL context lost
            scene.addEventListener('webglcontextlost', (event) => {
                console.error('WebGL context lost');
                event.preventDefault();
                showError('Graphics context lost. Please refresh the page.');
            });
            
            // Handle WebGL context restored
            scene.addEventListener('webglcontextrestored', (event) => {
                console.log('WebGL context restored');
                showMessage('Graphics context restored. AR should work normally now.');
            });
            
            // Add global error handler for uncaught AR.js errors
            window.addEventListener('error', (event) => {
                if (event.message && event.message.includes('AR')) {
                    console.error('Uncaught AR error:', event);
                    showError('Unexpected AR error occurred. Please refresh the page.');
                }
            });
            
            // Add unhandled promise rejection handler
            window.addEventListener('unhandledrejection', (event) => {
                if (event.reason && typeof event.reason === 'object' && 
                    (event.reason.message?.includes('AR') || event.reason.message?.includes('camera'))) {
                    console.error('Unhandled AR promise rejection:', event);
                    showError('AR initialization failed. Please refresh the page and allow camera access.');
                }
            });
        }
        
        function setupEventListeners() {
            document.getElementById('back-to-hud').addEventListener('click', () => {
                window.location.href = 'hud.html';
            });
            
            document.getElementById('minigame-action').addEventListener('click', handleMinigameAction);
            document.getElementById('minigame-reset').addEventListener('click', resetCurrentMinigame);
        }
        
        function initializeMarkerHandlers() {
            console.log('Registering marker handler component...');
            
            // Register enhanced marker found/lost handlers with fallback support
            AFRAME.registerComponent('markerhandler', {
                schema: {
                    checkpoint: {type: 'number'}
                },
                
                init: function() {
                    console.log(`Initializing marker handler for checkpoint ${this.data.checkpoint}`);
                    const markerId = this.el.id;
                    const isFallback = markerId.includes('fallback');
                    
                    this.el.addEventListener('markerFound', () => {
                        const checkpoint = this.data.checkpoint;
                        console.log(`✅ Marker ${checkpoint} found - ${markerId} (${isFallback ? 'fallback' : 'primary'})`);
                        
                        // Hide fallback markers when primary is found and vice versa
                        if (!isFallback) {
                            hideFallbackMarker(checkpoint);
                        } else {
                            hidePrimaryMarker(checkpoint);
                        }
                        
                        activateCheckpoint(checkpoint, isFallback);
                    });
                    
                    this.el.addEventListener('markerLost', () => {
                        const checkpoint = this.data.checkpoint;
                        console.log(`❌ Marker ${checkpoint} lost - ${markerId} (${isFallback ? 'fallback' : 'primary'})`);
                        
                        // Small delay before deactivating to avoid flickering
                        setTimeout(() => {
                            if (!isAnyMarkerVisible(checkpoint)) {
                                deactivateCheckpoint();
                            }
                        }, 500);
                    });
                    
                    // Add error handling for marker events
                    this.el.addEventListener('markerError', (event) => {
                        console.error(`Marker error for ${markerId}:`, event.detail);
                        showError(`Marker detection error. Please ensure good lighting and try again.`);
                    });
                }
            });
            
            console.log('Marker handler component registered successfully');
        }
        
        function hideFallbackMarker(checkpoint) {
            try {
                const fallbackMarker = document.querySelector(`#marker-${checkpoint}-fallback`);
                if (fallbackMarker) {
                    fallbackMarker.setAttribute('visible', 'false');
                    console.log(`🔒 Hidden fallback marker for checkpoint ${checkpoint}`);
                } else {
                    console.log(`ℹ️ No fallback marker found for checkpoint ${checkpoint} to hide`);
                }
            } catch (error) {
                console.error(`Error hiding fallback marker for checkpoint ${checkpoint}:`, error);
            }
        }
        
        function hidePrimaryMarker(checkpoint) {
            try {
                const primaryMarker = document.querySelector(`#marker-${checkpoint}`);
                if (primaryMarker) {
                    primaryMarker.setAttribute('visible', 'false');
                    console.log(`🔒 Hidden primary marker for checkpoint ${checkpoint}`);
                } else {
                    console.log(`ℹ️ No primary marker found for checkpoint ${checkpoint} to hide`);
                }
            } catch (error) {
                console.error(`Error hiding primary marker for checkpoint ${checkpoint}:`, error);
            }
        }
        
        function showAllMarkersForCheckpoint(checkpoint) {
            try {
                const primaryMarker = document.querySelector(`#marker-${checkpoint}`);
                const fallbackMarker = document.querySelector(`#marker-${checkpoint}-fallback`);
                
                if (primaryMarker) {
                    primaryMarker.setAttribute('visible', 'true');
                    console.log(`🔓 Enabled primary marker for checkpoint ${checkpoint}`);
                }
                if (fallbackMarker) {
                    fallbackMarker.setAttribute('visible', 'true');
                    console.log(`🔓 Enabled fallback marker for checkpoint ${checkpoint}`);
                }
            } catch (error) {
                console.error(`Error showing markers for checkpoint ${checkpoint}:`, error);
            }
        }
        
        function isAnyMarkerVisible(checkpoint) {
            try {
                const primaryMarker = document.querySelector(`#marker-${checkpoint}`);
                const fallbackMarker = document.querySelector(`#marker-${checkpoint}-fallback`);
                
                const primaryVisible = primaryMarker && primaryMarker.object3D && primaryMarker.object3D.visible;
                const fallbackVisible = fallbackMarker && fallbackMarker.object3D && fallbackMarker.object3D.visible;
                
                const isVisible = primaryVisible || fallbackVisible;
                console.log(`🔍 Checkpoint ${checkpoint} visibility: primary=${primaryVisible}, fallback=${fallbackVisible}, any=${isVisible}`);
                
                return isVisible;
            } catch (error) {
                console.error(`Error checking marker visibility for checkpoint ${checkpoint}:`, error);
                return false;
            }
        }
        
        function activateCheckpoint(checkpointNumber, isFallback = false) {
            console.log(`Activating checkpoint ${checkpointNumber}... (${isFallback ? 'fallback' : 'primary'} marker)`);
            
            let state = null;
            let isGameStateAvailable = false;
            
            // Try to get game state with error handling
            try {
                if (GameState && typeof GameState.getState === 'function') {
                    state = GameState.getState();
                    if (state && typeof state === 'object') {
                        isGameStateAvailable = true;
                        console.log('GameState available:', state);
                    } else {
                        console.warn('GameState.getState() returned invalid data:', state);
                    }
                } else {
                    console.warn('GameState not available or getState method missing');
                }
            } catch (error) {
                console.error('Error accessing GameState:', error);
                showError('Game state unavailable - continuing with basic AR functionality');
            }
            
            // Fallback state when GameState is unavailable
            if (!isGameStateAvailable) {
                console.log('Using fallback state - all checkpoints accessible');
                state = {
                    checkpoints: [], // Empty array means no checkpoints completed
                    keys: [],
                    teamId: 'fallback',
                    isGameComplete: false
                };
            }
            
            // Check if checkpoint is unlocked (only if GameState is available)
            if (isGameStateAvailable && checkpointNumber > 1 && !state.checkpoints.includes(checkpointNumber - 1)) {
                const message = `Checkpoint ${checkpointNumber} is locked! Complete previous checkpoints first.`;
                console.warn(message);
                showMessage(message);
                return;
            }
            
            // Check if already completed (only if GameState is available)
            if (isGameStateAvailable && state.checkpoints.includes(checkpointNumber)) {
                const message = `Checkpoint ${checkpointNumber} already completed!`;
                console.log(message);
                showMessage(message);
                return;
            }
            
            currentCheckpoint = checkpointNumber;
            
            // Enhanced content visibility logic for both primary and fallback markers
            let contentShown = false;
            
            try {
                // First, try to show the requested content type (primary or fallback)
                const primaryContentId = `#checkpoint-${checkpointNumber}-content`;
                const fallbackContentId = `#checkpoint-${checkpointNumber}-fallback-content`;
                
                const requestedContentId = isFallback ? fallbackContentId : primaryContentId;
                const requestedContent = document.querySelector(requestedContentId);
                
                if (requestedContent) {
                    // Hide all other content for this checkpoint first
                    const allPrimaryContent = document.querySelector(primaryContentId);
                    const allFallbackContent = document.querySelector(fallbackContentId);
                    
                    if (allPrimaryContent && allPrimaryContent !== requestedContent) {
                        allPrimaryContent.setAttribute('visible', 'false');
                    }
                    if (allFallbackContent && allFallbackContent !== requestedContent) {
                        allFallbackContent.setAttribute('visible', 'false');
                    }
                    
                    // Show the requested content
                    requestedContent.setAttribute('visible', 'true');
                    contentShown = true;
                    console.log(`✅ Checkpoint ${checkpointNumber} content displayed (${isFallback ? 'fallback' : 'primary'})`);
                } else {
                    console.warn(`❌ Requested content not found: ${requestedContentId}`);
                    
                    // Fallback logic: try the other content type
                    const alternativeContentId = isFallback ? primaryContentId : fallbackContentId;
                    const alternativeContent = document.querySelector(alternativeContentId);
                    
                    if (alternativeContent) {
                        alternativeContent.setAttribute('visible', 'true');
                        contentShown = true;
                        console.log(`⚠️ Using alternative content for checkpoint ${checkpointNumber} (${!isFallback ? 'fallback' : 'primary'})`);
                        showMessage(`Checkpoint ${checkpointNumber} loaded with alternative content`);
                    } else {
                        console.error(`❌ No content available for checkpoint ${checkpointNumber}`);
                        showError(`Checkpoint ${checkpointNumber} content unavailable`);
                    }
                }
            } catch (error) {
                console.error(`Error showing content for checkpoint ${checkpointNumber}:`, error);
                showError(`Error displaying checkpoint ${checkpointNumber} content`);
            }
            
            // Update UI with enhanced error handling
            try {
                const markerType = isFallback ? ' (Fallback)' : '';
                const gameStateStatus = isGameStateAvailable ? '' : ' [Offline Mode]';
                
                const titleElement = document.getElementById('ar-title');
                const checkpointElement = document.getElementById('current-checkpoint');
                
                if (titleElement) {
                    titleElement.textContent = getCheckpointName(checkpointNumber) + markerType + gameStateStatus;
                }
                if (checkpointElement) {
                    checkpointElement.textContent = `Checkpoint: ${checkpointNumber}${markerType}${gameStateStatus}`;
                }
            } catch (error) {
                console.error('Error updating UI:', error);
            }
            
            // Initialize minigame with enhanced error handling
            if (contentShown) {
                try {
                    initializeMinigame(checkpointNumber);
                    console.log(`✅ Checkpoint ${checkpointNumber} activated successfully`);
                    
                    const statusMsg = isGameStateAvailable 
                        ? `Checkpoint ${checkpointNumber} activated! ${isFallback ? 'Using fallback marker.' : ''}` 
                        : `Checkpoint ${checkpointNumber} activated in offline mode! ${isFallback ? 'Using fallback marker.' : ''}`;
                    showMessage(statusMsg);
                } catch (error) {
                    console.error(`❌ Error initializing minigame for checkpoint ${checkpointNumber}:`, error);
                    showError(`Error starting minigame for checkpoint ${checkpointNumber}. Please try scanning the marker again.`);
                }
            } else {
                console.error(`❌ Cannot initialize minigame - no content shown for checkpoint ${checkpointNumber}`);
                showError(`Checkpoint ${checkpointNumber} content failed to load`);
            }
        }
        
        function deactivateCheckpoint() {
            if (currentCheckpoint) {
                console.log(`🔄 Deactivating checkpoint ${currentCheckpoint}...`);
                
                try {
                    // Hide both primary and fallback content
                    const primaryContent = document.querySelector(`#checkpoint-${currentCheckpoint}-content`);
                    const fallbackContent = document.querySelector(`#checkpoint-${currentCheckpoint}-fallback-content`);
                    
                    if (primaryContent) {
                        primaryContent.setAttribute('visible', 'false');
                        console.log(`🔒 Hidden primary content for checkpoint ${currentCheckpoint}`);
                    }
                    if (fallbackContent) {
                        fallbackContent.setAttribute('visible', 'false');
                        console.log(`🔒 Hidden fallback content for checkpoint ${currentCheckpoint}`);
                    }
                    
                    // Re-enable both primary and fallback markers for future detection
                    showAllMarkersForCheckpoint(currentCheckpoint);
                    
                    // Reset UI with error handling
                    try {
                        const titleElement = document.getElementById('ar-title');
                        const checkpointElement = document.getElementById('current-checkpoint');
                        const minigameElement = document.getElementById('minigame-ui');
                        
                        if (titleElement) titleElement.textContent = 'Scan a Marker';
                        if (checkpointElement) checkpointElement.textContent = 'Checkpoint: None';
                        if (minigameElement) minigameElement.style.display = 'none';
                    } catch (uiError) {
                        console.error('Error resetting UI:', uiError);
                    }
                    
                    // Cleanup minigame with enhanced error handling
                    if (currentMinigame) {
                        try {
                            if (typeof currentMinigame.cleanup === 'function') {
                                currentMinigame.cleanup();
                                console.log(`🧹 Minigame cleanup completed for checkpoint ${currentCheckpoint}`);
                            } else {
                                console.log(`ℹ️ No cleanup method found for minigame ${currentCheckpoint}`);
                            }
                        } catch (error) {
                            console.error(`❌ Error cleaning up minigame for checkpoint ${currentCheckpoint}:`, error);
                        }
                        currentMinigame = null;
                    }
                    
                    console.log(`✅ Checkpoint ${currentCheckpoint} deactivated successfully`);
                    const previousCheckpoint = currentCheckpoint;
                    currentCheckpoint = null;
                    showMessage(`Checkpoint ${previousCheckpoint} deactivated`);
                    
                } catch (error) {
                    console.error(`❌ Error deactivating checkpoint ${currentCheckpoint}:`, error);
                    showError(`Error deactivating checkpoint ${currentCheckpoint}`);
                }
            } else {
                console.log('ℹ️ No checkpoint currently active to deactivate');
            }
        }
        
        function initializeMinigame(checkpointNumber) {
            console.log(`Initializing minigame for checkpoint ${checkpointNumber}...`);
            
            const minigames = {
                1: () => new CaptainCompassGame(),
                2: () => new KrakenQuizGame(),
                3: () => new CannonballAccuracyGame(),
                4: () => new TreasureChestLockGame(),
                5: () => new PirateBalanceGame(),
                6: () => new SkeletonDuelGame(),
                7: () => new MapAssemblyGame(),
                8: () => new LostLootGame()
            };
            
            if (minigames[checkpointNumber]) {
                try {
                    currentMinigame = minigames[checkpointNumber]();
                    currentMinigame.initialize();
                    
                    // Show minigame UI
                    document.getElementById('minigame-ui').style.display = 'block';
                    updateMinigameUI();
                    
                    console.log(`Minigame for checkpoint ${checkpointNumber} initialized successfully`);
                } catch (error) {
                    console.error(`Error creating minigame for checkpoint ${checkpointNumber}:`, error);
                    throw error;
                }
            } else {
                console.warn(`No minigame defined for checkpoint ${checkpointNumber}`);
            }
        }
        
        function handleMinigameAction() {
            if (currentMinigame && currentMinigame.handleAction) {
                try {
                    currentMinigame.handleAction();
                    updateMinigameUI();
                } catch (error) {
                    console.error('Error handling minigame action:', error);
                    showError('Error in minigame. Please try again.');
                }
            }
        }
        
        function resetCurrentMinigame() {
            if (currentMinigame && currentMinigame.reset) {
                try {
                    currentMinigame.reset();
                    updateMinigameUI();
                    console.log('Minigame reset successfully');
                } catch (error) {
                    console.error('Error resetting minigame:', error);
                    showError('Error resetting minigame. Please try scanning the marker again.');
                }
            }
        }
        
        function updateMinigameUI() {
            if (currentMinigame) {
                try {
                    const content = document.getElementById('minigame-content');
                    content.innerHTML = currentMinigame.getUIContent();
                    
                    // Update progress bar
                    const progressFill = document.getElementById('progress-fill');
                    progressFill.style.width = `${currentMinigame.getProgress()}%`;
                } catch (error) {
                    console.error('Error updating minigame UI:', error);
                }
            }
        }
        
        async function completeCheckpoint(checkpointNumber, earnedKey = false) {
            try {
                console.log(`Completing checkpoint ${checkpointNumber}, key earned: ${earnedKey}`);
                
                await GameState.completeCheckpoint(checkpointNumber, earnedKey);
                
                const message = `Checkpoint ${checkpointNumber} completed!${earnedKey ? ' Golden key earned!' : ''}`;
                showMessage(message);
                
                // Hide minigame UI after delay
                setTimeout(() => {
                    document.getElementById('minigame-ui').style.display = 'none';
                }, 2000);
                
            } catch (error) {
                console.error('Error completing checkpoint:', error);
                showError('Error saving progress. Please try again.');
            }
        }
        
        function getCheckpointName(number) {
            const names = {
                1: "Captain's Compass",
                2: "Kraken's Quiz", 
                3: "Cannonball Accuracy",
                4: "Treasure Chest Lock",
                5: "Pirate's Balance",
                6: "Skeleton Duel",
                7: "Map Assembly",
                8: "The Lost Loot"
            };
            return names[number] || `Checkpoint ${number}`;
        }
        
        function showMessage(message) {
            console.log('Showing message:', message);
            const instructions = document.getElementById('ar-instructions');
            instructions.innerHTML = `<p style="color: #00ff00;">${message}</p>`;
            
            setTimeout(() => {
                instructions.innerHTML = '<p>Point your camera at an AR marker to begin the minigame</p>';
            }, 3000);
        }
        
        function showError(message) {
            console.error('Showing error:', message);
            const instructions = document.getElementById('ar-instructions');
            instructions.innerHTML = `<p style="color: #ff4444; font-weight: bold;">⚠️ ${message}</p>`;
            
            setTimeout(() => {
                instructions.innerHTML = '<p>Point your camera at an AR marker to begin the minigame</p>';
            }, 5000);
        }
        
        function requestDeviceOrientation() {
            console.log('Checking device orientation permissions...');
            
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                console.log('Device orientation permission required (iOS)');
                DeviceOrientationEvent.requestPermission()
                    .then(response => {
                        if (response === 'granted') {
                            console.log('✅ Device orientation permission granted');
                        } else {
                            console.warn('❌ Device orientation permission denied');
                            showMessage('Device orientation permission denied. Some features may not work properly.');
                        }
                    })
                    .catch(error => {
                        console.error('Device orientation permission error:', error);
                        showMessage('Device orientation setup failed. Please check browser permissions.');
                    });
            } else {
                console.log('Device orientation permission not required');
            }
        }
        
        // Export functions for minigames to use
        window.ARView = {
            completeCheckpoint,
            showMessage,
            showError,
            updateMinigameUI,
            getCurrentCheckpoint: () => currentCheckpoint
        };
        
        // Debug function for testing
        window.ARDebug = {
            getState: () => ({
                arSceneReady,
                arInitialized,
                currentCheckpoint,
                hasMinigame: !!currentMinigame
            }),
            forceActivateCheckpoint: activateCheckpoint,
            testCameraPermission: requestCameraPermission
        };
    </script>
</body>
</html>