<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR Test - Lost Loot</title>
    <link rel="stylesheet" href="css/styles.css">
    <!-- A-Frame and AR.js -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.5/aframe/build/aframe-ar.min.js"></script>
</head>
<body class="ar-page">
    <!-- AR Scene -->
    <a-scene
        embedded
        arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3; cameraParametersUrl: data/camera_para.dat;"
        renderer="logarithmicDepthBuffer: true;"
        vr-mode-ui="enabled: false"
        gesture-detector
        id="ar-scene"
        loading-screen="enabled: false"
    >
        <!-- Assets -->
        <a-assets>
            <!-- Note: a-marker-camera is not needed when using pattern markers -->
        </a-assets>
        
        <!-- Test Marker 1 -->
        <a-marker
            id="marker-1"
            type="pattern" 
            url="assets/markers/marker-1.patt"
            markerhandler
            checkpoint="1"
        >
            <a-entity id="checkpoint-1-content" visible="false">
                <a-box
                    position="0 0.5 0"
                    rotation="0 45 0"
                    color="#8B4513"
                    scale="0.5 0.5 0.5"
                    animation="property: rotation; to: 0 405 0; loop: true; dur: 4000"
                >
                    <a-text
                        value="AR Test - Marker 1"
                        position="0 1 0"
                        align="center"
                        color="#FFD700"
                        scale="2 2 2"
                    ></a-text>
                </a-box>
            </a-entity>
        </a-marker>
        
        <!-- Camera -->
        <a-entity camera look-controls wasd-controls-enabled="false"></a-entity>
    </a-scene>
    
    <!-- AR UI Overlay -->
    <div class="ar-ui-overlay">
        <header class="ar-header">
            <h2 id="ar-title">AR Test - Scan Marker 1</h2>
        </header>
        
        <div id="ar-instructions" class="ar-instructions">
            <p>Point your camera at marker 1 pattern to test AR detection</p>
        </div>
        
        <div id="debug-info" style="position: fixed; bottom: 10px; left: 10px; background: rgba(0,0,0,0.8); color: white; padding: 10px; border-radius: 5px; font-family: monospace; font-size: 12px;">
            Status: Initializing...
        </div>
    </div>
    
    <!-- Mock utilities -->
    <script>
        // Mock GameState for testing
        window.GameState = {
            isInitialized: () => true,
            getState: () => ({ checkpoints: [], keys: [] }),
            completeCheckpoint: (num, key) => Promise.resolve()
        };
        
        // Mock ARUtils for testing
        window.ARUtils = {
            isARSupported: () => true,
            requestCameraPermission: async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                    stream.getTracks().forEach(track => track.stop());
                    return true;
                } catch (e) {
                    return false;
                }
            }
        };
    </script>
    
    <script>
        let arSceneReady = false;
        let arInitialized = false;
        let debugInfo = null;
        
        function updateDebug(message) {
            if (!debugInfo) debugInfo = document.getElementById('debug-info');
            debugInfo.innerHTML = `Status: ${message}<br>Scene Ready: ${arSceneReady}<br>AR Init: ${arInitialized}`;
            console.log('DEBUG:', message);
        }
        
        // Initialize AR test
        document.addEventListener('DOMContentLoaded', async () => {
            updateDebug('DOM loaded, initializing AR test...');
            
            try {
                // Check AR support
                if (!await checkARSupport()) {
                    updateDebug('AR not supported!');
                    return;
                }
                
                // Request camera permission
                const cameraPermission = await requestCameraPermission();
                if (!cameraPermission) {
                    updateDebug('Camera permission denied!');
                    return;
                }
                updateDebug('Camera permission granted');
                
                // Wait for A-Frame scene to be ready
                const scene = document.querySelector('#ar-scene');
                if (scene.hasLoaded) {
                    updateDebug('Scene already loaded');
                    onSceneReady();
                } else {
                    updateDebug('Waiting for scene to load...');
                    scene.addEventListener('loaded', onSceneReady);
                }
                
            } catch (error) {
                updateDebug(`Error: ${error.message}`);
                console.error('Error:', error);
            }
        });
        
        async function checkARSupport() {
            return ARUtils.isARSupported();
        }
        
        async function requestCameraPermission() {
            return await ARUtils.requestCameraPermission();
        }
        
        function onSceneReady() {
            updateDebug('Scene ready, registering components...');
            arSceneReady = true;
            
            try {
                initializeMarkerHandlers();
                arInitialized = true;
                updateDebug('AR initialized successfully!');
            } catch (error) {
                updateDebug(`AR init error: ${error.message}`);
                console.error('Error:', error);
            }
        }
        
        function initializeMarkerHandlers() {
            updateDebug('Registering marker handler...');
            
            AFRAME.registerComponent('markerhandler', {
                schema: {
                    checkpoint: {type: 'number'}
                },
                
                init: function() {
                    updateDebug(`Handler init for checkpoint ${this.data.checkpoint}`);
                    
                    this.el.addEventListener('markerFound', () => {
                        const checkpoint = this.data.checkpoint;
                        updateDebug(`🎯 MARKER ${checkpoint} FOUND!`);
                        activateCheckpoint(checkpoint);
                    });
                    
                    this.el.addEventListener('markerLost', () => {
                        const checkpoint = this.data.checkpoint;
                        updateDebug(`❌ MARKER ${checkpoint} LOST`);
                        deactivateCheckpoint();
                    });
                }
            });
            
            updateDebug('Marker handler registered');
        }
        
        function activateCheckpoint(checkpointNumber) {
            updateDebug(`Activating checkpoint ${checkpointNumber}...`);
            
            // Show checkpoint content
            const content = document.querySelector(`#checkpoint-${checkpointNumber}-content`);
            if (content) {
                content.setAttribute('visible', 'true');
                updateDebug(`✅ Checkpoint ${checkpointNumber} activated!`);
            } else {
                updateDebug(`❌ Content element not found for checkpoint ${checkpointNumber}`);
            }
            
            // Update UI
            document.getElementById('ar-title').textContent = `Checkpoint ${checkpointNumber} Active!`;
        }
        
        function deactivateCheckpoint() {
            updateDebug('Deactivating checkpoint...');
            
            // Hide all checkpoint content
            const contents = document.querySelectorAll('[id^="checkpoint-"][id$="-content"]');
            contents.forEach(content => {
                content.setAttribute('visible', 'false');
            });
            
            document.getElementById('ar-title').textContent = 'AR Test - Scan Marker 1';
            updateDebug('Checkpoint deactivated');
        }
    </script>
</body>
</html>